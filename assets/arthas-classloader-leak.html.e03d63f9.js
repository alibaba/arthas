import{_ as e,o as a,c as o,d as c}from"./app.b47c1ebd.js";const d={},t=c('<h1 id="arthasclassloader-\u5185\u5B58\u6CC4\u9732\u5206\u6790\u4E0E\u4FEE\u590D\u65B9\u6848" tabindex="-1"><a class="header-anchor" href="#arthasclassloader-\u5185\u5B58\u6CC4\u9732\u5206\u6790\u4E0E\u4FEE\u590D\u65B9\u6848" aria-hidden="true">#</a> ArthasClassLoader \u5185\u5B58\u6CC4\u9732\u5206\u6790\u4E0E\u4FEE\u590D\u65B9\u6848</h1><ul><li>\u65E5\u671F\uFF1A2025-12-27</li><li>\u4F5C\u8005\uFF1ACodex\uFF08AI\uFF09</li></ul><h2 id="\u80CC\u666F\u4E0E\u73B0\u8C61" tabindex="-1"><a class="header-anchor" href="#\u80CC\u666F\u4E0E\u73B0\u8C61" aria-hidden="true">#</a> \u80CC\u666F\u4E0E\u73B0\u8C61</h2><p>\u5728\u591A\u6B21 attach / stop / detach Arthas \u7684\u573A\u666F\u4E0B\uFF0C\u9884\u671F <code>com.taobao.arthas.agent.ArthasClassloader</code> \u80FD\u5728 stop \u540E\u88AB GC \u56DE\u6536\uFF0C \u4ECE\u800C\u5141\u8BB8\u4E0B\u6B21 attach \u91CD\u65B0\u52A0\u8F7D Arthas Core\uFF08<code>AgentBootstrap.resetArthasClassLoader()</code> \u4F1A\u628A\u9759\u6001\u5F15\u7528\u7F6E\u7A7A\uFF09\u3002</p><p>\u5B9E\u9645\u95EE\u9898\u662F\uFF1Astop/detach \u540E\uFF0C\u4E1A\u52A1\u7EBF\u7A0B\u7684 <code>Thread.threadLocals.table</code> \u91CC\u9057\u7559\u4E86\u7531 ArthasClassLoader \u52A0\u8F7D\u7684\u5BF9\u8C61\uFF0C \u5BFC\u81F4 ArthasClassLoader \u4E00\u76F4\u5904\u4E8E\u53EF\u8FBE\u72B6\u6001\uFF0C\u65E0\u6CD5\u88AB GC \u56DE\u6536\uFF0C\u6700\u7EC8\u8868\u73B0\u4E3A\u591A\u6B21 attach \u5185\u5B58\u6301\u7EED\u589E\u957F\u3002</p><p>\u53C2\u8003 PR\uFF1A<code>https://github.com/alibaba/arthas/pull/3077</code>\uFF08\u5173\u8054 issue\uFF1A#1794 #2137 #2978\uFF09</p><h2 id="\u6839\u56E0-\u4E1A\u52A1\u7EBF\u7A0B-threadlocalmap-\u6301\u6709-arthasclassloader-\u5BF9\u8C61" tabindex="-1"><a class="header-anchor" href="#\u6839\u56E0-\u4E1A\u52A1\u7EBF\u7A0B-threadlocalmap-\u6301\u6709-arthasclassloader-\u5BF9\u8C61" aria-hidden="true">#</a> \u6839\u56E0\uFF1A\u4E1A\u52A1\u7EBF\u7A0B ThreadLocalMap \u6301\u6709 ArthasClassLoader \u5BF9\u8C61</h2><p>\u6838\u5FC3\u70B9\uFF1A</p><ul><li>Advice \u56DE\u8C03\u662F\u5728\u201C\u4E1A\u52A1\u7EBF\u7A0B\u201D\u91CC\u6267\u884C\u7684\uFF08\u88AB\u589E\u5F3A\u7684\u65B9\u6CD5\u5728\u54EA\u4E2A\u7EBF\u7A0B\u8FD0\u884C\uFF0C\u5C31\u5728\u54EA\u4E2A\u7EBF\u7A0B\u56DE\u8C03\uFF09\u3002</li><li>Arthas \u7684\u90E8\u5206\u5B9E\u73B0\u4F7F\u7528\u4E86 <code>ThreadLocal</code> \u7F13\u5B58\u5BF9\u8C61\uFF08<strong>ThreadLocal \u7684 value \u5F3A\u5F15\u7528</strong>\uFF09\u3002</li><li>stop/detach \u65F6\u65E0\u6CD5\u9010\u7EBF\u7A0B\u6267\u884C <code>ThreadLocal.remove()</code>\uFF08JDK ThreadLocal API \u53EA\u80FD\u6E05\u7406\u201C\u5F53\u524D\u7EBF\u7A0B\u201D\u7684\u503C\uFF09\uFF0C\u5BFC\u81F4\u9057\u7559 value\u3002</li><li>\u8FD9\u4E9B value \u7684 class \u7531 ArthasClassLoader \u52A0\u8F7D\uFF0C\u56E0\u6B64\u5F62\u6210\u5F15\u7528\u94FE\uFF1A <ul><li><code>Thread (GC Root)</code> \u2192 <code>Thread.threadLocals.table</code> \u2192 <code>Entry.value</code> \u2192 <code>value.getClass()</code> \u2192 <code>ArthasClassLoader</code></li></ul></li></ul><p>\u5728 PR #3077 \u7684\u6392\u67E5\u4E2D\uFF0C\u5DF2\u660E\u786E\u7684\u6CC4\u9732\u70B9\u5305\u62EC\uFF1A</p><ul><li><code>ThreadLocalWatch.timestampRef</code>\uFF1A\u7528\u4E8E monitor/watch/trace/tt \u7B49\u547D\u4EE4\u8BA1\u65F6</li><li><code>ExpressFactory.expressRef</code>\uFF1A\u7528\u4E8E\u8868\u8FBE\u5F0F\u5F15\u64CE\uFF08OGNL\uFF09\u5BF9\u8C61\u7F13\u5B58</li></ul><p>\u8865\u5145\uFF1A<code>TimeTunnelAdviceListener.argsRef</code> \u4E5F\u4F1A\u628A <code>ObjectStack</code>\uFF08ArthasClassLoader \u52A0\u8F7D\uFF09\u653E\u5165\u4E1A\u52A1\u7EBF\u7A0B ThreadLocalMap\uFF0C \u540C\u6837\u5177\u5907 stop \u540E pin \u4F4F ArthasClassLoader \u7684\u98CE\u9669\uFF08\u53EA\u662F\u8BE5\u547D\u4EE4\u89E6\u53D1\u6761\u4EF6\u4E0D\u540C\uFF09\u3002</p><h2 id="\u4E3A\u4EC0\u4E48-watch-\u66F4\u5BB9\u6613\u89E6\u53D1" tabindex="-1"><a class="header-anchor" href="#\u4E3A\u4EC0\u4E48-watch-\u66F4\u5BB9\u6613\u89E6\u53D1" aria-hidden="true">#</a> \u4E3A\u4EC0\u4E48 watch \u66F4\u5BB9\u6613\u89E6\u53D1</h2><ul><li><code>watch</code> \u547D\u4EE4\u5728 Advice \u56DE\u8C03\u91CC\u4E00\u5B9A\u4F1A\u8FDB\u884C\u8BA1\u65F6\uFF08<code>ThreadLocalWatch.start()/costInMillis()</code>\uFF09\u3002</li><li>\u56E0\u6B64\u53EA\u8981\u4E1A\u52A1\u7EBF\u7A0B\u547D\u4E2D\u8FC7\u4E00\u6B21 watch \u589E\u5F3A\u70B9\uFF0C\u5C31\u4F1A\u5728\u8BE5\u7EBF\u7A0B\u7684 ThreadLocalMap \u91CC\u521B\u5EFA <code>timestampRef</code> \u7684 value\u3002</li><li>stop/detach \u540E value \u9057\u7559\uFF0C\u5BFC\u81F4 ArthasClassLoader \u88AB\u4E1A\u52A1\u7EBF\u7A0B\u95F4\u63A5\u6301\u6709\u3002</li></ul><p>\u800C <code>vmtool</code> \u8FD9\u7C7B\u547D\u4EE4\u5E76\u4E0D\u4F1A\u8D70 <code>ThreadLocalWatch</code> \u7684\u8BA1\u65F6\u903B\u8F91\uFF0C\u56E0\u6B64\u5728\u4E00\u4E9B\u95EE\u9898\u590D\u73B0\u4E2D\u9700\u8981\u4F9D\u8D56\u201C\u8868\u8FBE\u5F0F\u201D\u8DEF\u5F84\uFF0C \u624D\u4F1A\u89E6\u53D1 <code>ExpressFactory.expressRef</code> \u76F8\u5173\u7684 ThreadLocal \u7F13\u5B58\u3002</p><h2 id="\u8865\u5145\u6839\u56E0-termd-netty-\u7684-internalthreadlocalmap-\u9057\u7559-watch-\u5FC5\u73B0" tabindex="-1"><a class="header-anchor" href="#\u8865\u5145\u6839\u56E0-termd-netty-\u7684-internalthreadlocalmap-\u9057\u7559-watch-\u5FC5\u73B0" aria-hidden="true">#</a> \u8865\u5145\u6839\u56E0\uFF1ATermd/Netty \u7684 InternalThreadLocalMap \u9057\u7559\uFF08watch \u5FC5\u73B0\uFF09</h2><p>\u5728\u5B9E\u9645\u590D\u73B0\u4E2D\uFF0C\u5373\u4F7F\u4FEE\u590D\u4E86 Arthas \u81EA\u8EAB\u7684 <code>ThreadLocalWatch/ExpressFactory</code>\uFF0C\u4ECD\u53EF\u80FD\u51FA\u73B0 stop \u540E ArthasClassLoader \u65E0\u6CD5\u56DE\u6536\u3002</p><p>heap dump \u7684\u5178\u578B\u73B0\u8C61\uFF1A</p><ul><li>dominator \u4E3A <code>java.lang.Object[]</code>\uFF08\u7531 <code>&lt;system class loader&gt;</code> \u52A0\u8F7D\uFF09</li><li>\u8BE5 <code>Object[]</code> \u5B9E\u9645\u662F\u4E1A\u52A1\u7EBF\u7A0B\u7684 <code>ThreadLocalMap.table</code></li><li><code>table</code> \u4E2D\u5B58\u5728\u4E00\u4E2A value\uFF1A<code>com.alibaba.arthas.deps.io.netty.util.internal.InternalThreadLocalMap</code></li></ul><p>\u539F\u56E0\u89E3\u91CA\uFF1A</p><ul><li><code>watch</code> \u7684\u8F93\u51FA\u662F\u5728\u4E1A\u52A1\u7EBF\u7A0B\u91CC\u6267\u884C\u7684\uFF1A<code>WatchAdviceListener</code> \u2192 <code>process.appendResult(...)</code> \u2192 <code>ProcessOutput.write(...)</code> \u2192 <code>TermHandler.apply(...)</code> \u2192 <code>term.write(...)</code></li><li>Arthas \u7684 Term \u57FA\u4E8E termd\uFF0C\u800C termd \u5E95\u5C42\u4F7F\u7528 Netty\uFF1BNetty \u7684 FastThreadLocal \u4F1A\u5728\u5F53\u524D\u7EBF\u7A0B\u521B\u5EFA\u5E76\u7F13\u5B58 <code>InternalThreadLocalMap</code></li><li>\u5728 Arthas \u8FD0\u884C\u65F6\uFF0Ccore jar \u4F1A\u628A <code>io.netty.*</code> relocate \u5230 <code>com.alibaba.arthas.deps.io.netty.*</code>\uFF0C\u56E0\u6B64 dump \u4E2D\u770B\u5230\u7684\u662F relocate \u540E\u7684\u7C7B\u540D</li><li>\u5F53 <code>InternalThreadLocalMap</code> \u5B9E\u4F8B\u9057\u7559\u5728\u201C\u4E1A\u52A1\u7EBF\u7A0B\u201D\u7684 <code>ThreadLocalMap.table</code> \u4E2D\u65F6\uFF0C\u4F1A\u5F3A\u5F15\u7528 ArthasClassLoader \u52A0\u8F7D\u7684 Netty \u7C7B\uFF0C \u4ECE\u800C pin \u4F4F\u6574\u4E2A ArthasClassLoader</li></ul><h2 id="pr-3077-\u7684\u4FEE\u590D\u601D\u8DEF\u4E0E\u98CE\u9669\u70B9" tabindex="-1"><a class="header-anchor" href="#pr-3077-\u7684\u4FEE\u590D\u601D\u8DEF\u4E0E\u98CE\u9669\u70B9" aria-hidden="true">#</a> PR #3077 \u7684\u4FEE\u590D\u601D\u8DEF\u4E0E\u98CE\u9669\u70B9</h2><p>PR #3077 \u7684\u4E3B\u8981\u601D\u8DEF\uFF1A</p><ul><li>\u7531\u4E8E\u65E0\u6CD5\u8DE8\u7EBF\u7A0B\u6E05\u7406 JDK ThreadLocal\uFF0C\u4E8E\u662F\u628A <code>ThreadLocal</code> \u6539\u9020\u6210\u4E00\u4E2A\u53EF <code>cleanUp()</code> \u7684\u7ED3\u6784\uFF08<code>ConcurrentHashMap</code> \u5B58\u50A8\uFF09\u3002</li><li>\u5728 <code>AdviceListener.destroy()</code> \u65F6\u8C03\u7528 <code>cleanUp()</code>\uFF0C\u628A\u6240\u6709\u7EBF\u7A0B\u5173\u8054\u7684\u6570\u636E\u4E00\u6B21\u6027\u6E05\u6389\u3002</li></ul><p>\u9700\u8981\u5173\u6CE8\u7684\u6F5C\u5728\u95EE\u9898\uFF1A</p><ul><li>\u4F7F\u7528 <code>Thread.getId()</code> \u4F5C\u4E3A key \u4F1A\u5F15\u5165\u201C\u7EBF\u7A0B id \u590D\u7528\u201D\u7684\u7406\u8BBA\u98CE\u9669\uFF08\u89C4\u8303\u5141\u8BB8\u590D\u7528\uFF09\u3002</li><li>map \u65B9\u6848\u4F1A\u8BA9\u77ED\u751F\u547D\u5468\u671F\u7EBF\u7A0B\u7684\u6761\u76EE\u5728\u547D\u4EE4\u7ED3\u675F\u524D\u65E0\u6CD5\u81EA\u52A8\u91CA\u653E\uFF08\u7EBF\u7A0B\u7ED3\u675F\u4E0D\u7B49\u4E8E\u6761\u76EE\u91CA\u653E\uFF09\uFF0C\u53EF\u80FD\u5728\u957F\u65F6\u95F4\u8FD0\u884C\u547D\u4EE4\u4E0B\u653E\u5927\u5185\u5B58\u5360\u7528\u3002</li></ul><h2 id="\u66F4\u7A33\u59A5\u7684\u4FEE\u590D\u65B9\u6848-\u63A8\u8350" tabindex="-1"><a class="header-anchor" href="#\u66F4\u7A33\u59A5\u7684\u4FEE\u590D\u65B9\u6848-\u63A8\u8350" aria-hidden="true">#</a> \u66F4\u7A33\u59A5\u7684\u4FEE\u590D\u65B9\u6848\uFF08\u63A8\u8350\uFF09</h2><p>\u76EE\u6807\uFF1A<strong>\u4E0D\u4F9D\u8D56 stop/detach \u65F6\u8DE8\u7EBF\u7A0B\u6E05\u7406</strong>\uFF0C\u800C\u662F\u4ECE\u6839\u6E90\u907F\u514D\u628A\u201CArthasClassLoader \u52A0\u8F7D\u7684\u5BF9\u8C61\u201D\u5F3A\u5F15\u7528\u8FDB\u4E1A\u52A1\u7EBF\u7A0B ThreadLocalMap\u3002</p><p>\u5177\u4F53\u7B56\u7565\uFF1A</p><ol><li>\u5BF9\u201C\u8BA1\u65F6/\u6808\u201D\u7B49\u4EC5\u9700\u5B58\u653E\u57FA\u7840\u6570\u636E\u7684 ThreadLocal\uFF1A\u628A value \u6539\u4E3A JDK/Bootstrap \u7C7B\u578B\uFF08\u4F8B\u5982 <code>long[]</code>\u3001<code>Object[]</code>\uFF09\uFF0C \u5373\u4F7F stop \u540E value \u9057\u7559\uFF0C\u4E5F\u4E0D\u4F1A pin \u4F4F ArthasClassLoader\u3002</li><li>\u5BF9\u5FC5\u987B\u7F13\u5B58 Arthas \u5BF9\u8C61\uFF08\u5982 <code>Express</code>\uFF09\u7684 ThreadLocal\uFF1A\u628A value \u5305\u88C5\u4E3A <code>WeakReference</code>\uFF0C \u6253\u65AD <code>ThreadLocalMap.value</code> \u2192 <code>Arthas \u5BF9\u8C61</code> \u7684\u5F3A\u5F15\u7528\u94FE\uFF0C\u4FDD\u8BC1 stop/detach \u540E\u65E7 ArthasClassLoader \u53EF\u88AB GC\u3002</li></ol><p>\u672C\u4ED3\u5E93\u5DF2\u6309\u4E0A\u8FF0\u601D\u8DEF\u843D\u5730\u7684\u6539\u52A8\uFF1A</p><ul><li><code>core/src/main/java/com/taobao/arthas/core/util/ThreadLocalWatch.java</code>\uFF1A<code>ThreadLocal&lt;LongStack&gt;</code> \u2192 <code>ThreadLocal&lt;long[]&gt;</code></li><li><code>core/src/main/java/com/taobao/arthas/core/command/express/ExpressFactory.java</code>\uFF1A<code>ThreadLocal&lt;Express&gt;</code> \u2192 <code>ThreadLocal&lt;WeakReference&lt;Express&gt;&gt;</code></li><li><code>core/src/main/java/com/taobao/arthas/core/command/monitor200/TimeTunnelAdviceListener.java</code>\uFF1A<code>ThreadLocal&lt;ObjectStack&gt;</code> \u2192 <code>ThreadLocal&lt;Object[]&gt;</code></li><li><code>core/src/main/java/com/taobao/arthas/core/shell/command/internal/TermHandler.java</code>\uFF1A<code>term.write()</code> \u540E <code>InternalThreadLocalMap.remove()</code> \u6E05\u7406 Netty ThreadLocal</li></ul><h2 id="\u5EFA\u8BAE\u7684\u9A8C\u8BC1\u65B9\u5F0F" tabindex="-1"><a class="header-anchor" href="#\u5EFA\u8BAE\u7684\u9A8C\u8BC1\u65B9\u5F0F" aria-hidden="true">#</a> \u5EFA\u8BAE\u7684\u9A8C\u8BC1\u65B9\u5F0F</h2><p>\u63A8\u8350\u4F7F\u7528 heap dump / MAT / jcmd \u9A8C\u8BC1 stop/detach \u4E4B\u540E\u662F\u5426\u8FD8\u5B58\u5728\u5982\u4E0B\u53EF\u8FBE\u94FE\uFF1A</p><ul><li><code>Thread</code> \u2192 <code>threadLocals</code> \u2192 <code>Entry.value</code> \u2192 <code>ClassLoader</code>\uFF08\u6307\u5411\u65E7 ArthasClassLoader\uFF09</li></ul><p>\u91CD\u70B9\u5173\u6CE8\u4E24\u7C7B value\uFF1A</p><ul><li>Arthas \u81EA\u8EAB\u7684 <code>ThreadLocal&lt;ArthasType&gt;</code>\uFF1A\u4F8B\u5982 <code>LongStack/ObjectStack/Express</code> \u7B49</li><li>termd/netty \u76F8\u5173\u7684 <code>InternalThreadLocalMap</code>\uFF08dump \u4E2D\u901A\u5E38\u4E3A relocate \u540E\u7684 <code>com.alibaba.arthas.deps.io.netty...</code>\uFF09</li></ul><p>\u82E5\u9A8C\u8BC1\u4ECD\u5931\u8D25\uFF0C\u53EF\u7EE7\u7EED\u5168\u5C40\u641C\u7D22\u201C\u4E1A\u52A1\u7EBF\u7A0B Advice \u56DE\u8C03\u8DEF\u5F84\u201D\u4E2D\u662F\u5426\u8FD8\u6709\u65B0\u7684 <code>ThreadLocal&lt;ArthasType&gt;</code> \u5199\u5165\u70B9\uFF0C\u6216\u662F\u5426\u8FD8\u6709\u5176\u4ED6\u4F9D\u8D56\u5728\u4E1A\u52A1\u7EBF\u7A0B\u521B\u5EFA\u4E86 ThreadLocal \u5E76\u9057\u7559\u3002</p>',38),r=[t];function l(s,h){return a(),o("div",null,r)}const p=e(d,[["render",l],["__file","arthas-classloader-leak.html.vue"]]);export{p as default};
