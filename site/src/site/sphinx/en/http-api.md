Http API
========


Http API provides a RESTful-like interactive interface, and both
requests and responses data in JSON format. Compared with
Telnet/WebConsole's output unstructured text data, Http API can provide
structured data and support more complex interactive functions, such as
a series of diagnostic operations in specific application scenarios.


### Interface Description

**Access address**  
The Http API address is: `http://ip:port/api`, the request parameters
must be submitted using `POST`. Such as POST
`http://127.0.0.1:8563/api`.  
Note: The telnet port `3658` has compatibility issues with the Chrome
browser. It is recommended to use the http port `8563` to access the
http api.


**Request format**

```
{
  "action": "exec",
  "requestId": "req112"
  "sessionId": "94766d3c-8b39-42d3-8596-98aee3ccbefb"
  "consumerId": "955dbd1325334a84972b0f3ac19de4f7_2"
  "command": "version",
  "execTimeout": "10000"
}
```
Request data format description:

* `action` : The requested action/behavior, please refer to "Request
  Action Description" for optional values.
*  `requestId` : Optional request ID, generated by the client.
*  `sessionId` : Arthas session ID.
*  `consumerId` : Arthas consumer ID, used for multi-person sharing
   sessions.
*  `command` : Arthas command line
*  `execTimeout` : Timeout for executing commands (ms)

Note that different actions use different parameters. Set the parameters
according to the specific action.

**Request Action Description**  
Currently supported request actions are as follows:

* `exec` : The command is executed synchronously, and the command
  results is returned after the command execution end or interrupted.
*  `async_exec` : The command is executed asynchronously, and the
   scheduling result of the command is returned immediately. The command
   execution result is obtained through `pull_results` action.
*  `interrupt_job` : To interrupt the foreground command of the session,
   similar to the function of Telnet `Ctrl + c`.
*  `pull_results` : Get the result of the command executed
   asynchronously, and execute it repeatedly in http long-polling mode.
*  `init_session` : Create new session.
*  `join_session` : Join the session, used to support multiple people
   sharing the same Arthas session.
*  `close_session` : Close the session.

**Response status**  
The state attribute in the response indicates the request processing
state, and its value is as follows:

* `SCHEDULED`: When the command is executed asynchronously, it means that
  the job has been created, and may not be executed yet or is being
  executed;
* `SUCCEEDED`: The request is processed successfully (completed status);
* `FAILED`: Request processing failed (completed status), usually
  accompanied by a message explaining the reason;
* `REFUSED`: The request is rejected (completed status), usually
  accompanied by a message explaining the reason; 

### One-time command
Similar to executing batch commands, there is no need to create/close
sessions. The commands are executed synchronously without specifying the
`sessionId` parameter.

```
{
  "action": "exec",
  "command": "<Arthas command line>"
}
```

For example, get the Arthas version number:

```
curl -Ss -XPOST http://localhost:8563/api -d '
{
  "action":"exec",
  "command":"version"
}
'
```
The response is as follows:

```
{
   "state" : "SUCCEEDED",
   "sessionId" : "ee3bc004-4586-43de-bac0-b69d6db7a869",
   "body" : {
      "results" : [
         {
            "type" : "version",
            "version" : "3.3.8-SNAPSHOT",
            "jobId" : 5
         },
         {
            "jobId" : 5,
            "statusCode" : 0,
            "type" : "status"
         }
      ],
      "timeExpired" : false,
      "command" : "version",
      "jobStatus" : "TERMINATED",
      "jobId" : 5
   }
}
```
Response data format description:

* `state`: Request processing status, refer to the description of
  "Response Status".
*  `sessionId `: Arthas session ID, one-time command to automatically
   create and destroy temporary sessions.
*  `body.jobId`: The job ID of the command, all output results of the
   same job are the same jobId.
*  `body.jobStatus`: The job status of the command.
*  `body.timeExpired`: Whether the job execution timed out.
* `body/results`: Command execution results.

**Command result format description**

```
 [{
    "type" : "version",
    "version" : "3.3.8-SNAPSHOT",
    "jobId" : 5
 },
 {
    "jobId" : 5,
    "statusCode" : 0,
    "type" : "status"
 }]
```

* `type` : The command result type, except for the special ones such as
  `status`, the others remain the same as the Arthas command name.
  Please refer to the section
  "[Special command result description](#special_command_results)".
*  `jobId` : The job ID of the command.
*  Other fields are the data of each different command.

Note: You can also use a one-time command to execute continuous output
commands such as watch/trace, but you can't interrupt the command
execution, and there may be hang up for a long time. Please refer to the
example in the
"[Make watch command output a map object](#change_watch_value_to_map)"
section.  
Please try to deal with it in the following way:

* Set a reasonable `execTimeout` to forcibly interrupt the command
  execution after the timeout period is reached to avoid a long hang.
* Use the `-n` parameter to specify a smaller number of executions.
* Ensure the methods of the command matched can be successfully hit and
  the `condition-express` is written correctly. If the `watch/trace` does
  not hit, even if `-n 1` is specified, it will hang and wait until the
  execution timeout.


