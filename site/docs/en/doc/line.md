# line

::: tip
Observe the data when the function executes to a specified position.
:::

This allows you to easily observe the data at a specific point during function execution. 
The observable range includes: `local variables`, `parameters`, and if it's an instance method, you can also observe `the current object` by writing OGNL expressions.

## Parameter Description

The parameters for line are as follows:

|               Parameter Name | Description                                     |
|-----------------------------:|:------------------------------------------------|
|              _class-pattern_ | pattern for the class name                      |
|             _method-pattern_ | pattern for the method name                     |
|                   _location_ | **LineNumber** or **LineCode**                  |
|                    _express_ | expression to watch, default value `varMap`     |
|          _condition-express_ | condition expression to filter                                           |
|                         [x:] | the depth to print the specified property with default value: 1, the max value is 4                      |

The **location** parameter is crucial as it determines where to observe. It has two types of values:

- **LineNumber**:Line number, which refers to the specific line in the source file. For example, in the code below, `print(number, primeFactors);` has **LineNumber=25**, meaning observation occurs before executing **line 25**.
```java
package demo;

import java.util.ArrayList;
import java.util.List;
import java.util.Random;
import java.util.concurrent.TimeUnit;

public class MathGame {
    private static Random random = new Random();

    private int illegalArgumentCount = 0;

    public static void main(String[] args) throws InterruptedException {
        MathGame game = new MathGame();
        while (true) {
            game.run();
            TimeUnit.SECONDS.sleep(1);
        }
    }

    public void run() throws InterruptedException {
        try {
            int number = random.nextInt() / 10000;
            List<Integer> primeFactors = primeFactors(number);
            print(number, primeFactors);

        } catch (Exception e) {
            System.out.println(String.format("illegalArgumentCount:%3d, ", illegalArgumentCount) + e.getMessage());
        }
    }
}
```
::: tip
When **LineNumber**=**-1**, it means observation occurs before the function ends.
:::

::: tip
You cannot use**LineNumber**=**26**, because this line number cannot be found in the classes file.
:::

- **LineCode**:Special line identifier like **abcd-1**,generated by Arthas and can only be founded using `jad --lineCode`,For detailed usage refer to [Using LineCode for Observation](#Using-LineCode-for-Observation)

Additionally, observation expressions are composed of OGNL expressions. Similar to watch commands, you can write `"{params,varMap}"`,any valid OGNL expression will be supported.

Observation dimensions differ from watch command; it adds `varMap`,but lacks `throwExp`、`returnObj`.

**Special Notes**:

- Why we need to use **LineCode** ？   

  Because in Kotlin or some complex java expressions, it's not always possible to locate desired observation by line number. Arthas-generated **LineCode** provides finer-grained positioning.

- Why limit observations within a specific function?

  Most troubleshooting targets specific functions;
  Without specifying functions, enhancing code or generating **LineCode** might require traversing entire classes which could be costly;
  In practice local source code and the code actually running may not always match; specifying functions helps users detect discrepancies early.


## Usage

### Start Demo

Start `math-game` in [Quick Start](quick-start.md).

### Observe  `Local Variables` at Specific Position During Function Execution

::: tip
Observation expression defaults to `varMap`
:::

```bash
$ line demo.MathGame run 25 -x 2
Press Q or Ctrl+C to abort.
Affect(class count: 1 , method count: 1) cost in 17 ms, listenerId: 2
method=demo.MathGame.run line=25
ts=2024-06-21 09:57:34.452; result=@HashMap[
    @String[primeFactors]:@ArrayList[
        @Integer[2],
        @Integer[7],
        @Integer[7],
        @Integer[991],
    ],
    @String[number]:@Integer[97118],
]
```

- The above result shows that before executing line **25** ,local variables `primeFactors` and `number` have these values.

### Use `-x` to check more details

```bash
$ line demo.MathGame run 25 "{varMap}" -x 3
Press Q or Ctrl+C to abort.
Affect(class count: 1 , method count: 1) cost in 19 ms, listenerId: 4
method=demo.MathGame.run line=25
ts=2024-06-21 10:04:09.641; result=@ArrayList[
    @HashMap[
        @String[primeFactors]:@ArrayList[
            @Integer[2],
            @Integer[2],
            @Integer[3],
            @Integer[3],
            @Integer[17],
            @Integer[79],
        ],
        @String[number]:@Integer[48348],
    ],
]
```

- `-x`: Expand level of object (1 by default)
- The max value of `-x` is 4, to prevent the expansion result taking up too much memory. Users can specify the field in the `ognl` expression.

### Use condition expressions to locate specific call

```bash
$ line demo.MathGame run 25 "{varMap}" "varMap[\"primeFactors\"][0]==2" -x 3
Press Q or Ctrl+C to abort.
Affect(class count: 1 , method count: 1) cost in 20 ms, listenerId: 12
method=demo.MathGame.run line=25
ts=2024-06-21 10:08:03.392; result=@ArrayList[
    @HashMap[
        @String[primeFactors]:@ArrayList[
            @Integer[2],
            @Integer[7],
            @Integer[31],
            @Integer[251],
        ],
        @String[number]:@Integer[108934],
    ],
]

```

- Only calls that meet the conditions will receive a response.

### Check the field of the target object

- `target` is the `this` object in java.

```bash
$ line demo.MathGame run 25 'target'
Press Q or Ctrl+C to abort.
Affect(class count: 1 , method count: 1) cost in 18 ms, listenerId: 13
method=demo.MathGame.run line=25
ts=2024-06-21 10:10:00.761; result=@MathGame[
    random=@Random[java.util.Random@bebdb06],
    illegalArgumentCount=@Integer[1677],
]
```

- `target.field_name`: the field of the current object.

```bash
$ line demo.MathGame run 25 'target.illegalArgumentCount'
Press Q or Ctrl+C to abort.
Affect(class count: 1 , method count: 1) cost in 20 ms, listenerId: 14
method=demo.MathGame.run line=25
ts=2024-06-21 10:10:28.838; result=@Integer[1687]
```

### Using LineCode for Observation
::: tip
When we cannot locate the desired observation position through the line number, we need to use **LineCode** for specification.
:::

First, use `jad --lineCode ` to locate the specific mapping location.

```bash
$ jad --lineCode demo.MathGame run
ClassLoader:                                                                                                                                                                                                                       
+-sun.misc.Launcher$AppClassLoader@18b4aac2                                                                                                                                                                                        
  +-sun.misc.Launcher$ExtClassLoader@1540e19d                                                                                                                                                                                      

Location:                                                                                                                                                                                                                          
/Users/xxxxx/IdeaProjects/github/arthas/math-game/target/classes/                                                                                                                                                               

       public void run() throws InterruptedException {
           try {
/*23*/         int number = random.nextInt() / 10000;
/*24*/         List<Integer> primeFactors = this.primeFactors(number);
/*25*/         MathGame.print(number, primeFactors);
           }
           catch (Exception e) {
/*28*/         System.out.println(String.format("illegalArgumentCount:%3d, ", this.illegalArgumentCount) + e.getMessage());
           }
       }

------------------------- lineCode location -------------------------
format: /*LineNumber*/ (LineCode)-> Instruction
/*23 */ (aacd-1)->  
                  invoke-method:java/util/Random#nextInt:()I
/*23 */ (5918-1)->  
                  assign-variable:e
/*24 */ (653f-1)->  
                  invoke-method:demo/MathGame#primeFactors:(I)Ljava/util/List;
/*24 */ (d961-1)->  
                  assign-variable:primeFactors
/*25 */ (416e-1)->  
                  invoke-method:demo/MathGame#print:(ILjava/util/List;)V
/*27 */ (5918-2)->  
                  assign-variable:e
/*28 */ (2455-1)->  
                  invoke-method:java/lang/StringBuilder#<init>:()V
/*28 */ (4076-1)->  
                  invoke-method:java/lang/Integer#valueOf:(I)Ljava/lang/Integer;
/*28 */ (b6e4-1)->  
                  invoke-method:java/lang/String#format:(Ljava/lang/String;[Ljava/lang/Object;)Ljava/lang/String;
/*28 */ (850c-1)->  
                  invoke-method:java/lang/StringBuilder#append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
/*28 */ (a53d-1)->  
                  invoke-method:java/lang/Exception#getMessage:()Ljava/lang/String;
/*28 */ (850c-2)->  
                  invoke-method:java/lang/StringBuilder#append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
/*28 */ (f7bb-1)->  
                  invoke-method:java/lang/StringBuilder#toString:()Ljava/lang/String;
/*28 */ (2f1b-1)->  
                  invoke-method:java/io/PrintStream#println:(Ljava/lang/String;)V
Affect(row-cnt:1) cost in 103 ms.
```
Below the `--- lineCode location ---`  separator in the above result is information related to **LineCode** positioning:
- `/*25 */` indicates the line number adjacent to this instruction.
- `(416e-1)` indicates a special line identifier, which is **LineCode**, specifying the exact position for observation.
- `invoke-method: xxx` represents that this instruction is calling a method.
- `assign-variable: xxx` represents that this instruction is assigning a value to a variable.

The following example observes before the execution of `invoke-method:demo/MathGame#print:(ILjava/util/List;)V`:
```bash
$ line demo.MathGame run 416e-1 -x 2
Press Q or Ctrl+C to abort.
Affect(class count: 1 , method count: 1) cost in 21 ms, listenerId: 16
method=demo.MathGame.run line=416e-1
ts=2024-06-21 10:37:50.531; result=@HashMap[
    @String[primeFactors]:@ArrayList[
        @Integer[5],
        @Integer[5],
        @Integer[6907],
    ],
    @String[number]:@Integer[172675],
]
```
- By using `jad --lineCode` we see that **LineCode=416e-1** is located above `invoke-method:demo/MathGame#print:(ILjava/util/List;)V` ,which is our observation point.
- Additionally, combining the line number, source code, and instruction sequence, we know that the instruction `invoke-method:demo/MathGame#print:(ILjava/util/List;)V` corresponds to the source code `print(number, primeFactors);`
